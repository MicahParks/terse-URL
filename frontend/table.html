<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Terse URL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css"
          integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w=="
          crossorigin="anonymous"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
            crossorigin="anonymous"></script>
</head>
<body>
<table id="terseTable" class="table table-striped">
    <thead>
    <tr>
        <th scope="col">Shortened URL</th>
        <th scope="col">Original URL</th>
        <th scope="col">Redirect Type</th>
        <th scope="col">Visit Count</th>
        <th scope="col">Actions</th>
    </tr>
    </thead>
    <tbody id="terseTableBody">
    <tr id="templateTerseRow">
        <td title="bob"></td>
        <td></td>
        <td></td>
        <td></td>
        <td>
            <button type="button" class="btn btn-primary">
                <i class="far fa-edit"></i>
            </button>
            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#downloadModal"
                    data-bs-shortened="">
                <i class="fas fa-download"></i>
            </button> <!--TODO Make this a modal where they can choose what kind of data to export?-->
            <button type="button" class="btn btn-danger">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
    </tbody>
</table>
<div class="modal fade" id="downloadModal" tabindex="-1" aria-labelledby="downloadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="downloadModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <button type="button" class="btn-lg btn-primary"
                        onclick="downloadExport('terse', $(this).attr('data-bs-shortened'))">Terse
                </button>
                <button type="button" class="btn-lg btn-primary"
                        onclick="downloadExport('visits', $(this).attr('data-bs-shortened'))">Visits
                </button>
                <button type="button" class="btn-lg btn-primary"
                        onclick="downloadExport('all', $(this).attr('data-bs-shortened'))">All
                </button>
            </div>
        </div>
    </div>
</div>
<script src="data.js"></script>
<script src="delete.js"></script>
<script src="browserDownload.js"></script>
<script src="export.js"></script>
<script src="form.js"></script>
<script src="prefix.js"></script>
<script src="summary.js"></script>
<script src="table.js"></script>
<script src="write.js"></script>
<script>

    let originalTemplate = document.getElementById("templateTerseRow");
    let template = originalTemplate.cloneNode(true);
    let table = document.getElementById("terseTableBody");
    table.removeChild(originalTemplate);
    template.id = "summaryData";

    buildTable();

    function buildTable() {

        let index = 0;
        summarize(null).then(function (summaries) {
            for (const [_, summary] of Object.entries(summaries)) { // TODO Using _ as blank identifier...

                let row = template.cloneNode(true);
                row.id = template.id + index;
                index++;

                row.cells[0].innerHTML = summary.shortenedURL;
                row.cells[1].innerHTML = summary.originalURL;
                row.cells[2].innerHTML = summary.redirectType;
                row.cells[3].innerHTML = summary.visitCount;

                table.appendChild(row);

                for (let button of $('#' + row.id + ' :button')) {
                    button.setAttribute('data-bs-shortened', summary.shortenedURL);
                }
            }
        });
    }
</script>
<script>
    let exampleModal = document.getElementById('downloadModal')
    exampleModal.addEventListener('show.bs.modal', function (event) {
        // Button that triggered the modal
        let button = event.relatedTarget;
        // Extract info from data-bs-* attributes
        currentShortened = button.getAttribute('data-bs-shortened');
        // If necessary, you could initiate an AJAX request here
        // and then do the updating in a callback.
        //
        // Update the modal's content.
        let modalTitle = exampleModal.querySelector('.modal-title');

        modalTitle.textContent = 'Export ' + currentShortened;
    })

</script>
<script>

    let currentShortened = "";

    function downloadExport(type) {

        switch (type) {
            case "all":
                exportSome([currentShortened]).then(function (response) {
                    download(currentShortened + ".json", JSON.stringify(response));
                });
        }
    }
</script>
</body>
</html>
